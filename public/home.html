<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home - myapp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">

  <style>

   <!-- .blog { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
    .blog img { max-width: 100%; margin-top: 10px; } -->
.blog {
  border: none;
  padding: 20px;
  margin: 20px auto;
  border-radius: 20px;
  width: 100%;
  max-width: 850px;
  min-height: 500px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  background: white;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
  transition: transform 0.2s ease-in-out;
}

.blog:hover {
  transform: translateY(-3px);
}

.blog img {
  width: 100%;
  height: 300px; /* Set a fixed height */
  object-fit: contain; /* Ensures full image is visible without cropping */
  object-position: center; /* Centers the image */
  border-radius: 5px;
  background: #f8f8f8; /* Adds a background to prevent blank spaces */
}


    .like-btn, .comment-btn { margin-right: 5px; }
    .search-result { cursor: pointer; padding: 5px; border-bottom: 1px solid #ddd; }


body {
  background: linear-gradient(rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.6)), 
              url('https://www.dawsoncollege.qc.ca/humanities/wp-content/uploads/sites/95/anatomy-of-a-blog-post-header-3-800x418.jpg');
  background-size: cover;
  background-repeat: no-repeat;
  background-attachment: fixed;
  background-position: center;
}




/* Navbar styled like a container */
.navbar {
  background-color: white !important;
  border-radius: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  margin: 20px;
  padding: 10px 20px;
}

/* Nav links style */
.navbar .nav-link {
  color: #333 !important;
  font-weight: 500;
  padding: 10px 15px;
  border-radius: 10px;
  transition: background-color 0.3s, color 0.3s;
}

.navbar .nav-link:hover {
  background-color: #f0f0f0;
  color: #007bff !important;
}

/* Logout button styling */
.navbar .btn-danger {
  border-radius: 10px;
  font-weight: 500;
  padding: 8px 16px;
  background-color: #ff4d4d;
  border: none;
  transition: background-color 0.3s ease;
}

.navbar .btn-danger:hover {
  background-color: #e60000;
}







#search-user {
  border: none;
  padding: 12px 16px;
  font-size: 16px;
  border-radius: 20px; /* Increased rounded corners */
}

#search-btn {
  border-radius: 20px; /* Match input rounded corners */
  padding: 12px 20px;  /* Optional: makes it more balanced */
  font-size: 16px;
}


  </style>
</head>
<body>

  <!-- Navigation Bar with Bot link -->
<nav class="navbar navbar-expand-lg navbar-light">
    <div class="container">
      
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="home.html">
                        <i class="fas fa-home me-1"></i> Home
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="friend.html">
                        <i class="fas fa-user-friends me-1"></i> Friend
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="group.html">
                        <i class="fas fa-users me-1"></i> Group
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="bot.html">
                        <i class="fas fa-comments me-1"></i> Bot
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="gd.html">
                        <i class="fas fa-users-cog me-1"></i> GD
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="ra.html">
                        <i class="fas fa-file-alt me-1"></i> Resume
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="game.html">
                        <i class="fas fa-gamepad me-1"></i> Games
                    </a>
                </li>
            </ul>
<div class="container mt-2 d-flex justify-content-end align-items-center gap-2" style="height: 50px;">
  <span class="badge bg-info text-dark d-flex align-items-center" id="welcome-user"
    style="font-size: 1.1rem; font-weight: bold; padding: 10px 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); height: 40px;">
    ðŸ‘‹ Welcome, admin
  </span>

  <a class="btn btn-danger d-flex align-items-center justify-content-center" href="/logout" title="Logout"
    style="width: 40px; height: 40px; padding: 0;">
    <i class="fas fa-sign-out-alt"></i>
  </a>
</div>

        </div>
    </div>
</nav>


  <div class="container mt-4">
    <!-- User Search -->
    <div class="mb-3">
      <div class="input-group">
        <input type="text" id="search-user" class="form-control" placeholder="Search users...">
        <button id="search-btn" class="btn btn-primary">Search</button>
      </div>
    </div>
    <div id="search-results" class="mb-3"></div>
    <!-- Blogs Section -->
    <div class="mb-3">
      <button id="create-blog-btn" class="btn btn-success">Create Blog</button>
    </div>
    <div id="blog-list"></div>
  </div>
  
  <!-- Modal for Blog Creation -->
  <div class="modal" tabindex="-1" id="create-blog-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create Blog</h5>
          <button type="button" class="btn-close" id="close-blog-modal"></button>
        </div>
        <div class="modal-body">
          <textarea id="blog-content" class="form-control" placeholder="Write your blog..."></textarea>
          <input type="file" id="blog-image" class="form-control mt-2">
        </div>
        <div class="modal-footer">
          <button id="submit-blog" class="btn btn-primary">Submit</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Scripts -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const socket = io();
    const loggedInUser = sessionStorage.getItem('username');
    socket.emit('register user', { username: loggedInUser });
    
    function loadBlogs() {
      fetch('/api/blogs')
        .then(res => res.json())
        .then(blogs => {
          const blogList = document.getElementById('blog-list');
          blogList.innerHTML = '';
          blogs.forEach(blog => {
            const div = document.createElement('div');
            div.className = 'blog';
            div.setAttribute('data-id', blog.id);
            div.innerHTML = `<h5>${blog.username}</h5>
              <p>${blog.content}</p>
              ${blog.image ? `<img src="${blog.image}" alt="Blog Image">` : ''}
              <div>
                <button class="btn btn-outline-primary btn-sm like-btn" data-id="${blog.id}">Like (<span id="likes-${blog.id}">${blog.likes}</span>)</button>
                <input type="text" class="form-control d-inline-block w-50 comment-input" data-id="${blog.id}" placeholder="Comment">
                <button class="btn btn-outline-secondary btn-sm comment-btn" data-id="${blog.id}">Comment</button>
                ${blog.username === loggedInUser ? `
                  <button class="btn btn-outline-warning btn-sm edit-blog-btn" data-id="${blog.id}">Edit</button>
                  <button class="btn btn-outline-danger btn-sm delete-blog-btn" data-id="${blog.id}">Delete</button>
                ` : ''}
              </div>
              <div class="mt-2" id="comments-${blog.id}"></div>`;
            // Load comments for this blog
            fetch(`/api/blogcomments?blogId=${blog.id}`)
              .then(res => res.json())
              .then(comments => {
                const commentDiv = document.getElementById(`comments-${blog.id}`);
                comments.forEach(c => {
                  const p = document.createElement('p');
                  p.textContent = `${c.username}: ${c.comment}`;
                  commentDiv.appendChild(p);
                });
              });
            blogList.prepend(div);
          });
        });
    }
    loadBlogs();
// Fetch session user from backend
fetch('/api/me')
  .then(res => res.json())
  .then(data => {
    const welcomeEl = document.getElementById('welcome-user');
    if (data.username) {
      welcomeEl.textContent = `ðŸ‘‹ Welcome, ${data.username}`;
    }
  });

    
    socket.on('new blog', () => { loadBlogs(); });
    socket.on('blog updated', (blog) => { document.getElementById(`likes-${blog.id}`).textContent = blog.likes; });
    socket.on('blog comment', () => { loadBlogs(); });
    
    const createBlogBtn = document.getElementById('create-blog-btn');
    const createBlogModal = new bootstrap.Modal(document.getElementById('create-blog-modal'));
    document.getElementById('close-blog-modal').addEventListener('click', () => { createBlogModal.hide(); });
    createBlogBtn.addEventListener('click', () => { createBlogModal.show(); });
    document.getElementById('submit-blog').addEventListener('click', () => {
      const content = document.getElementById('blog-content').value;
      const imageInput = document.getElementById('blog-image');
      const editId = document.getElementById('submit-blog').getAttribute('data-edit-id');
      
      if(imageInput.files && imageInput.files[0]) {
        const formData = new FormData();
        formData.append('blogImage', imageInput.files[0]);
        fetch('/upload', { method: 'POST', body: formData })
          .then(response => response.json())
          .then(data => {
            if(editId) {
              socket.emit('edit blog', { 
                blogId: editId, 
                username: loggedInUser, 
                content, 
                image: data.url 
              });
            } else {
              socket.emit('create blog', { username: loggedInUser, content, image: data.url });
            }
            createBlogModal.hide();
          })
          .catch(err => { console.error(err); createBlogModal.hide(); });
      } else {
        if(editId) {
          socket.emit('edit blog', { 
            blogId: editId, 
            username: loggedInUser, 
            content, 
            image: null 
          });
        } else {
          socket.emit('create blog', { username: loggedInUser, content, image: null });
        }
        createBlogModal.hide();
      }
      document.getElementById('submit-blog').removeAttribute('data-edit-id');
    });
    
    document.addEventListener('click', (e) => {
      if(e.target.classList.contains('like-btn')) {
        const blogId = e.target.getAttribute('data-id');
        socket.emit('blog like', { blogId, username: loggedInUser });
      }
      if(e.target.classList.contains('comment-btn')) {
        const blogId = e.target.getAttribute('data-id');
        const input = document.querySelector(`.comment-input[data-id="${blogId}"]`);
        const comment = input.value;
        if(comment.trim() !== "") {
          socket.emit('blog comment', { blogId, username: loggedInUser, comment });
        }
        input.value = '';
      }
      if (e.target.classList.contains('edit-blog-btn')) {
        const blogId = e.target.getAttribute('data-id');
        const blogElement = e.target.closest('.blog');
        const blogContent = blogElement.querySelector('p').textContent;
        const blogImage = blogElement.querySelector('img')?.src;
        
        document.getElementById('blog-content').value = blogContent;
        document.getElementById('blog-image').value = '';
        document.getElementById('submit-blog').setAttribute('data-edit-id', blogId);
        createBlogModal.show();
      }
      
      if (e.target.classList.contains('delete-blog-btn')) {
        const blogId = e.target.getAttribute('data-id');
        if (confirm('Are you sure you want to delete this blog?')) {
          socket.emit('delete blog', { blogId, username: loggedInUser });
        }
      }
    });
    
    // Handle blog updates
    socket.on('blog updated', (blog) => {
      const blogElement = document.querySelector(`.blog[data-id="${blog.id}"]`);
      if (blogElement) {
        blogElement.querySelector('p').textContent = blog.content;
        const imgElement = blogElement.querySelector('img');
        if (imgElement) {
          imgElement.src = blog.image || '';
        }
      }
    });

    socket.on('blog deleted', (data) => {
      const blogElement = document.querySelector(`.blog[data-id="${data.blogId}"]`);
      if (blogElement) {
        blogElement.remove();
      }
    });
    
    document.getElementById('search-btn').addEventListener('click', () => {
      const query = document.getElementById('search-user').value;
      fetch(`/search/users?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(users => {
          const results = document.getElementById('search-results');
          results.innerHTML = '';
          users.forEach(user => {
            const div = document.createElement('div');
            div.className = 'search-result';
            div.textContent = `${user.username} (${user.email})`;
            div.addEventListener('click', () => {
              sessionStorage.setItem('privateChatTarget', user.username);
              window.location.href = '/friend';
            });
            results.appendChild(div);
          });
        });
    });
  </script>
</body>
</html>
